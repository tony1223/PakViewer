name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¸ç™¼æ¢ä»¶ï¼šæ¨é€ v é–‹é ­çš„ tagï¼Œä¾‹å¦‚ v1.26.0

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_NAME: PakViewer

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

        # è§£æç‰ˆæœ¬è™Ÿï¼Œå°‡æ™‚é–“æˆ³åˆ†å‰²æˆç¬¦åˆ .NET æ ¼å¼
        # ä¾‹å¦‚: v1.26.01122103 -> 1.26.112.2103 (MAJOR.YEAR.MMDD.HHMM)
        if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]{8})$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          YEAR="${BASH_REMATCH[2]}"
          TIMESTAMP="${BASH_REMATCH[3]}"
          MMDD="${TIMESTAMP:0:4}"
          HHMM="${TIMESTAMP:4:4}"
          # ç§»é™¤å‰å°é›¶ä»¥é¿å…å…«é€²åˆ¶è§£æå•é¡Œ
          MMDD=$((10#$MMDD))
          HHMM=$((10#$HHMM))
          DOTNET_VERSION="${MAJOR}.${YEAR}.${MMDD}.${HHMM}"
        else
          # å¦‚æœä¸æ˜¯æ™‚é–“æˆ³æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨åŸç‰ˆæœ¬è™Ÿ
          DOTNET_VERSION="$VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore PakViewer.csproj -r win-x64

    - name: Build Self-Contained
      run: |
        dotnet publish PakViewer.csproj -f net10.0-windows --configuration Release --runtime win-x64 --self-contained true --no-restore -o publish-sc /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Build Framework-Dependent
      run: |
        dotnet publish PakViewer.csproj -f net10.0-windows --configuration Release --self-contained false -o publish-fd /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Create ZIP archives
      shell: pwsh
      run: |
        Compress-Archive -Path "publish-sc/*" -DestinationPath "${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64-self-contained.zip"
        Compress-Archive -Path "publish-fd/*" -DestinationPath "${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64.zip"

    - name: Upload self-contained artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-win-x64-self-contained
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64-self-contained.zip

    - name: Upload framework-dependent artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-win-x64
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64.zip

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

        # è§£æç‰ˆæœ¬è™Ÿï¼Œå°‡æ™‚é–“æˆ³åˆ†å‰²æˆç¬¦åˆ .NET æ ¼å¼
        # ä¾‹å¦‚: v1.26.01122103 -> 1.26.112.2103 (MAJOR.YEAR.MMDD.HHMM)
        if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]{8})$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          YEAR="${BASH_REMATCH[2]}"
          TIMESTAMP="${BASH_REMATCH[3]}"
          MMDD="${TIMESTAMP:0:4}"
          HHMM="${TIMESTAMP:4:4}"
          # ç§»é™¤å‰å°é›¶ä»¥é¿å…å…«é€²åˆ¶è§£æå•é¡Œ
          MMDD=$((10#$MMDD))
          HHMM=$((10#$HHMM))
          DOTNET_VERSION="${MAJOR}.${YEAR}.${MMDD}.${HHMM}"
        else
          # å¦‚æœä¸æ˜¯æ™‚é–“æˆ³æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨åŸç‰ˆæœ¬è™Ÿ
          DOTNET_VERSION="$VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore PakViewer.csproj -r linux-x64

    - name: Build and Publish
      run: |
        dotnet publish PakViewer.csproj -f net10.0 --configuration Release --runtime linux-x64 --self-contained true --no-restore -o publish /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Create ZIP archive
      run: |
        cd publish
        chmod +x ${{ env.PROJECT_NAME }}* 2>/dev/null || true
        zip -r "../${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-linux-x64.zip" .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-linux-x64
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-linux-x64.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

        # è§£æç‰ˆæœ¬è™Ÿï¼Œå°‡æ™‚é–“æˆ³åˆ†å‰²æˆç¬¦åˆ .NET æ ¼å¼
        # ä¾‹å¦‚: v1.26.01122103 -> 1.26.112.2103 (MAJOR.YEAR.MMDD.HHMM)
        if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]{8})$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          YEAR="${BASH_REMATCH[2]}"
          TIMESTAMP="${BASH_REMATCH[3]}"
          MMDD="${TIMESTAMP:0:4}"
          HHMM="${TIMESTAMP:4:4}"
          # ç§»é™¤å‰å°é›¶ä»¥é¿å…å…«é€²åˆ¶è§£æå•é¡Œ
          MMDD=$((10#$MMDD))
          HHMM=$((10#$HHMM))
          DOTNET_VERSION="${MAJOR}.${YEAR}.${MMDD}.${HHMM}"
        else
          # å¦‚æœä¸æ˜¯æ™‚é–“æˆ³æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨åŸç‰ˆæœ¬è™Ÿ
          DOTNET_VERSION="$VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: |
        dotnet restore PakViewer.csproj -r osx-x64
        dotnet restore PakViewer.csproj -r osx-arm64

    - name: Build x64
      run: |
        dotnet publish PakViewer.csproj -f net10.0 --configuration Release --runtime osx-x64 --self-contained true -o publish-x64 /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Build arm64
      run: |
        dotnet publish PakViewer.csproj -f net10.0 --configuration Release --runtime osx-arm64 --self-contained true -o publish-arm64 /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Create Universal Binary
      run: |
        mkdir -p publish-universal
        # è¤‡è£½éåŸ·è¡Œæª”
        cp -R publish-x64/* publish-universal/
        # ä½¿ç”¨ lipo å»ºç«‹ universal binary
        for file in publish-x64/${{ env.PROJECT_NAME }}*; do
          filename=$(basename "$file")
          if [ -f "publish-arm64/$filename" ] && file "$file" | grep -q "Mach-O"; then
            echo "Creating universal binary for $filename"
            lipo -create "publish-x64/$filename" "publish-arm64/$filename" -output "publish-universal/$filename"
          fi
        done
        chmod +x publish-universal/${{ env.PROJECT_NAME }}* 2>/dev/null || true

    - name: Create ZIP archive
      run: |
        cd publish-universal
        zip -r "../${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-osx-universal.zip" .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-osx-universal
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-osx-universal.zip

  release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List artifacts
      run: find artifacts -type f -name "*.zip"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: ${{ env.PROJECT_NAME }} ${{ steps.get_version.outputs.TAG }}
        body: |
          ## ${{ env.PROJECT_NAME }} ${{ steps.get_version.outputs.TAG }}

          ### Downloads

          | Platform | File | Note |
          |----------|------|------|
          | Windows x64 | `*-win-x64.zip` | éœ€å®‰è£ [.NET 10 Runtime](https://dotnet.microsoft.com/download/dotnet/10.0) |
          | Windows x64 | `*-win-x64-self-contained.zip` | åŒ…å« .NET Runtimeï¼Œå¯ç›´æ¥åŸ·è¡Œ |
          | Linux x64 | `*-linux-x64.zip` | Self-contained |
          | macOS Universal | `*-osx-universal.zip` | Self-contained, æ”¯æ´ Intel & Apple Silicon |

          ### macOS / Linux ä½¿ç”¨èªªæ˜

          **macOS** (æœªç°½ç½²ï¼Œéœ€æ‰‹å‹•å…è¨±åŸ·è¡Œ):
          ```bash
          # è§£å£“ç¸®å¾Œï¼Œç§»é™¤ quarantine å±¬æ€§
          xattr -cr PakViewer
          # æˆ–åœ¨ç³»çµ±åå¥½è¨­å®š > å®‰å…¨æ€§èˆ‡éš±ç§ ä¸­å…è¨±åŸ·è¡Œ
          ```

          **Linux**:
          ```bash
          # è§£å£“ç¸®å¾Œï¼Œçµ¦äºˆåŸ·è¡Œæ¬Šé™
          chmod +x PakViewer
          ./PakViewer
          ```

          ### Changes
          See [commit history](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }}) for details.
        files: |
          artifacts/**/*.zip
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.TAG, '-') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify Discord Channel
      if: success()
      run: |
        curl -H "Content-Type: application/json" \
          -d "{\"content\": \"ğŸ‰ **PakViewer ${{ steps.get_version.outputs.TAG }}** å·²ç™¼å¸ƒï¼\n\nä¸‹è¼‰: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG }}\"}" \
          ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: Notify Discord Thread
      if: success()
      env:
        DISCORD_THREAD_URL: ${{ secrets.DISCORD_WEBHOOK_THREAD_URL }}
      run: |
        if [ -n "$DISCORD_THREAD_URL" ]; then
          curl -H "Content-Type: application/json" \
            -d "{\"content\": \"ğŸ‰ **PakViewer ${{ steps.get_version.outputs.TAG }}** å·²ç™¼å¸ƒï¼\n\nä¸‹è¼‰: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG }}\"}" \
            "$DISCORD_THREAD_URL"
        fi

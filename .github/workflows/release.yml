name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 觸發條件：推送 v 開頭的 tag，例如 v1.26.0

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_NAME: PakViewer

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

        # 解析版本號，將時間戳分割成符合 .NET 格式
        # 例如: v1.26.01122103 -> 1.26.112.2103 (MAJOR.YEAR.MMDD.HHMM)
        if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]{8})$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          YEAR="${BASH_REMATCH[2]}"
          TIMESTAMP="${BASH_REMATCH[3]}"
          MMDD="${TIMESTAMP:0:4}"
          HHMM="${TIMESTAMP:4:4}"
          # 移除前導零以避免八進制解析問題
          MMDD=$((10#$MMDD))
          HHMM=$((10#$HHMM))
          DOTNET_VERSION="${MAJOR}.${YEAR}.${MMDD}.${HHMM}"
        else
          # 如果不是時間戳格式，直接使用原版本號
          DOTNET_VERSION="$VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build and Publish
      run: |
        dotnet publish PakViewer.csproj -f net10.0-windows --configuration Release --runtime win-x64 --self-contained true -o publish /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Create ZIP archive
      shell: pwsh
      run: |
        Compress-Archive -Path "publish/*" -DestinationPath "${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64.zip"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-win-x64
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-win-x64.zip

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

        # 解析版本號，將時間戳分割成符合 .NET 格式
        # 例如: v1.26.01122103 -> 1.26.112.2103 (MAJOR.YEAR.MMDD.HHMM)
        if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]{8})$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          YEAR="${BASH_REMATCH[2]}"
          TIMESTAMP="${BASH_REMATCH[3]}"
          MMDD="${TIMESTAMP:0:4}"
          HHMM="${TIMESTAMP:4:4}"
          # 移除前導零以避免八進制解析問題
          MMDD=$((10#$MMDD))
          HHMM=$((10#$HHMM))
          DOTNET_VERSION="${MAJOR}.${YEAR}.${MMDD}.${HHMM}"
        else
          # 如果不是時間戳格式，直接使用原版本號
          DOTNET_VERSION="$VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build and Publish
      run: |
        dotnet publish PakViewer.csproj -f net10.0 --configuration Release --runtime linux-x64 --self-contained true -o publish /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Create ZIP archive
      run: |
        cd publish
        chmod +x ${{ env.PROJECT_NAME }}* 2>/dev/null || true
        zip -r "../${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-linux-x64.zip" .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-linux-x64
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-linux-x64.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

        # 解析版本號，將時間戳分割成符合 .NET 格式
        # 例如: v1.26.01122103 -> 1.26.112.2103 (MAJOR.YEAR.MMDD.HHMM)
        if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]{8})$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          YEAR="${BASH_REMATCH[2]}"
          TIMESTAMP="${BASH_REMATCH[3]}"
          MMDD="${TIMESTAMP:0:4}"
          HHMM="${TIMESTAMP:4:4}"
          # 移除前導零以避免八進制解析問題
          MMDD=$((10#$MMDD))
          HHMM=$((10#$HHMM))
          DOTNET_VERSION="${MAJOR}.${YEAR}.${MMDD}.${HHMM}"
        else
          # 如果不是時間戳格式，直接使用原版本號
          DOTNET_VERSION="$VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "DOTNET_VERSION=$DOTNET_VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build x64
      run: |
        dotnet publish PakViewer.csproj -f net10.0 --configuration Release --runtime osx-x64 --self-contained true -o publish-x64 /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Build arm64
      run: |
        dotnet publish PakViewer.csproj -f net10.0 --configuration Release --runtime osx-arm64 --self-contained true -o publish-arm64 /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:Version=${{ steps.get_version.outputs.DOTNET_VERSION }}

    - name: Create Universal Binary
      run: |
        mkdir -p publish-universal
        # 複製非執行檔
        cp -R publish-x64/* publish-universal/
        # 使用 lipo 建立 universal binary
        for file in publish-x64/${{ env.PROJECT_NAME }}*; do
          filename=$(basename "$file")
          if [ -f "publish-arm64/$filename" ] && file "$file" | grep -q "Mach-O"; then
            echo "Creating universal binary for $filename"
            lipo -create "publish-x64/$filename" "publish-arm64/$filename" -output "publish-universal/$filename"
          fi
        done
        chmod +x publish-universal/${{ env.PROJECT_NAME }}* 2>/dev/null || true

    - name: Create ZIP archive
      run: |
        cd publish-universal
        zip -r "../${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-osx-universal.zip" .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-osx-universal
        path: ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.TAG }}-osx-universal.zip

  release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "TAG=$TAG" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List artifacts
      run: find artifacts -type f -name "*.zip"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: ${{ env.PROJECT_NAME }} ${{ steps.get_version.outputs.TAG }}
        body: |
          ## ${{ env.PROJECT_NAME }} ${{ steps.get_version.outputs.TAG }}

          ### Downloads

          | Platform | File | Note |
          |----------|------|------|
          | Windows x64 | `*-win-x64.zip` | Self-contained, 可直接執行 |
          | Linux x64 | `*-linux-x64.zip` | Self-contained |
          | macOS Universal | `*-osx-universal.zip` | Self-contained, 支援 Intel & Apple Silicon |

          ### macOS / Linux 使用說明

          **macOS** (未簽署，需手動允許執行):
          ```bash
          # 解壓縮後，移除 quarantine 屬性
          xattr -cr PakViewer
          # 或在系統偏好設定 > 安全性與隱私 中允許執行
          ```

          **Linux**:
          ```bash
          # 解壓縮後，給予執行權限
          chmod +x PakViewer
          ./PakViewer
          ```

          ### Changes
          See [commit history](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }}) for details.
        files: |
          artifacts/**/*.zip
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.TAG, '-') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
